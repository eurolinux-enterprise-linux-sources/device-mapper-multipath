---
 libmultipath/config.c   |   60 +++++++++++++++++++++++++++++++++++++++++++++++-
 libmultipath/config.h   |    1 
 libmultipath/dict.c     |   38 ++++++++++++++++++++++++++++++
 libmultipath/dmparser.h |    1 
 4 files changed, 99 insertions(+), 1 deletion(-)

Index: multipath-tools/libmultipath/config.c
===================================================================
--- multipath-tools.orig/libmultipath/config.c
+++ multipath-tools/libmultipath/config.c
@@ -21,6 +21,7 @@
 #include "prio.h"
 #include "version.h"
 #include "devmapper.h"
+#include "dmparser.h"
 
 static int
 hwe_strmatch (struct hwentry *hwe1, struct hwentry *hwe2)
@@ -96,6 +97,8 @@ find_hwe (vector hwtable, char * vendor,
 	hw.revision = revision;
 
 	vector_foreach_slot (hwtable, hwe, i) {
+		if (hwe->all_devs == 1)
+			continue;
 		if (hwe_regmatch(hwe, &hw))
 			continue;
 		ret = hwe;
@@ -318,6 +321,57 @@ merge_hwe (struct hwentry * hwe1, struct
 	return 0;
 }
 
+#define overwrite_str(s) \
+do { \
+        if (src->s) { \
+		if (dst->s) \
+			FREE(dst->s); \
+                if (!(dst->s = set_param_str(src->s))) \
+                        return 1; \
+        } \
+} while(0)
+
+#define overwrite_num(s) \
+do { \
+	if (src->s) \
+		dst->s = src->s; \
+} while(0)
+
+static int
+overwrite_hwe (struct hwentry * dst, struct hwentry * src)
+{
+	overwrite_str(getuid);
+	overwrite_str(features);
+	overwrite_str(hwhandler);
+	overwrite_str(selector);
+	overwrite_str(checker_name);
+	overwrite_str(prio_name);
+	overwrite_str(prio_args);
+	overwrite_str(bl_product);
+	overwrite_num(pgpolicy);
+	overwrite_num(pgfailback);
+	overwrite_num(rr_weight);
+	overwrite_num(no_path_retry);
+	overwrite_num(minio);
+	overwrite_num(minio_rq);
+	overwrite_num(pg_timeout);
+	overwrite_num(flush_on_last_del);
+	overwrite_num(fast_io_fail);
+	overwrite_num(dev_loss);
+	overwrite_num(user_friendly_names);
+	overwrite_num(retain_hwhandler);
+	overwrite_num(detect_prio);
+
+	if (dst->no_path_retry == NO_PATH_RETRY_FAIL && dst->features) {
+		char *tmp;
+		remove_feature(dst->features, "queue_if_no_path");
+		tmp = realloc(dst->features, strlen(dst->features) + 1);
+		if (tmp)
+			dst->features = tmp;
+	}
+	return 0;
+}
+
 int
 store_hwe (vector hwtable, struct hwentry * dhwe)
 {
@@ -402,7 +456,11 @@ factorize_hwtable (vector hw, int n)
 
 		j = n;
 		vector_foreach_slot_after(hw, hwe2, j) {
-			if (conf->regex_match){
+			if (hwe1->all_devs == 1) {
+				overwrite_hwe(hwe2, hwe1);
+				continue;
+			}
+			else if (conf->regex_match){
 				if (hwe_regmatch(hwe2, hwe1))
 					continue;
 			}
Index: multipath-tools/libmultipath/config.h
===================================================================
--- multipath-tools.orig/libmultipath/config.h
+++ multipath-tools/libmultipath/config.h
@@ -27,6 +27,7 @@ struct hwentry {
 	char * prio_name;
 	char * prio_args;
 
+	int all_devs;
 	int pgpolicy;
 	int pgfailback;
 	int rr_weight;
Index: multipath-tools/libmultipath/dict.c
===================================================================
--- multipath-tools.orig/libmultipath/dict.c
+++ multipath-tools/libmultipath/dict.c
@@ -891,6 +891,32 @@ device_handler(vector strvec)
 }
 
 static int
+all_devs_handler(vector strvec)
+{
+	char * buff;
+	struct hwentry *hwe = VECTOR_LAST_SLOT(conf->hwtable);
+
+	if (!hwe)
+		return 1;
+
+	buff = set_value(strvec);
+	if (!buff)
+		return 1;
+
+	if ((strlen(buff) == 2 && !strcmp(buff, "no")) ||
+	    (strlen(buff) == 1 && !strcmp(buff, "0")))
+		hwe->all_devs = 0;
+	else if ((strlen(buff) == 3 && !strcmp(buff, "yes")) ||
+		 (strlen(buff) == 1 && !strcmp(buff, "1")))
+		hwe->all_devs = 1;
+	else
+		hwe->all_devs = 0;
+
+	FREE(buff);
+	return 0;
+}
+
+static int
 vendor_handler(vector strvec)
 {
 	struct hwentry * hwe = VECTOR_LAST_SLOT(conf->hwtable);
@@ -2082,6 +2108,17 @@ snprint_hw_dev_loss(char * buff, int len
 }
 
 static int
+snprint_hw_all_devs (char *buff, int len, void *data)
+{
+	struct hwentry * hwe = (struct hwentry *)data;
+
+	if (!hwe->all_devs)
+		return 0;
+
+	return snprintf(buff, len, "yes");
+}
+
+static int
 snprint_hw_vendor (char * buff, int len, void * data)
 {
 	struct hwentry * hwe = (struct hwentry *)data;
@@ -2817,6 +2854,7 @@ init_keywords(void)
 	install_keyword_root("devices", &devices_handler);
 	install_keyword_multi("device", &device_handler, NULL);
 	install_sublevel();
+	install_keyword("all_devs", &all_devs_handler, &snprint_hw_all_devs);
 	install_keyword("vendor", &vendor_handler, &snprint_hw_vendor);
 	install_keyword("product", &product_handler, &snprint_hw_product);
 	install_keyword("revision", &revision_handler, &snprint_hw_revision);
Index: multipath-tools/libmultipath/dmparser.h
===================================================================
--- multipath-tools.orig/libmultipath/dmparser.h
+++ multipath-tools/libmultipath/dmparser.h
@@ -1,3 +1,4 @@
 int assemble_map (struct multipath *);
 int disassemble_map (vector, char *, struct multipath *);
 int disassemble_status (char *, struct multipath *);
+int remove_feature (char *features, char *old);
