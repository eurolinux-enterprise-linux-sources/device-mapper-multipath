This is backport from:
http://git.opensvc.com/gitweb.cgi?p=multipath-tools/.git;a=commitdiff;h=50b26122b914acaafc3d4fbddd3f95903dc1387d

diff -up multipath-tools/kpartx/kpartx.c.orig multipath-tools/kpartx/kpartx.c
--- multipath-tools/kpartx/kpartx.c.orig	2013-03-07 09:28:23.373712784 +0800
+++ multipath-tools/kpartx/kpartx.c	2013-03-07 09:42:58.252579434 +0800
@@ -188,7 +188,8 @@ get_hotplug_device(void)
 
 int
 main(int argc, char **argv){
-	int fd, i, j, k, n, op, off, arg;
+	int i, j, k, n, op, off, arg;
+	int fd = -1;
 	struct slice all;
 	struct pt *ptp;
 	enum action what = LIST;
@@ -364,8 +365,10 @@ main(int argc, char **argv){
 			printf("%s: %d slices\n", ptp->type, n);
 #endif
 
-		if (n > 0)
+		if (n > 0) {
 			close(fd);
+			fd = -1;
+		}
 		else
 			continue;
 
@@ -394,15 +397,6 @@ main(int argc, char **argv){
 				       slices[j].start);
 			}
 
-			if (loopcreated && S_ISREG (buf.st_mode)) {
-				if (del_loop(device)) {
-					if (verbose)
-						printf("can't del loop : %s\n",
-							device);
-					exit(1);
-				}
-				printf("loop deleted : %s\n", device);
-			}
 			break;
 
 		case DELETE:
@@ -491,6 +485,18 @@ main(int argc, char **argv){
 		if (n > 0)
 			break;
 	}
+
+	if (what == LIST && loopcreated && S_ISREG (buf.st_mode)) {
+		if (fd != -1)
+			close(fd);
+		if (del_loop(device)) {
+			if (verbose)
+				printf("can't del loop : %s\n",
+				       device);
+			exit(1);
+		}
+		printf("loop deleted : %s\n", device);
+	}
 	dm_udev_wait(cookie);
 	dm_lib_release();
 	dm_lib_exit();
